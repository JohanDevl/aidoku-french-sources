name: Build sources
on:
  push:
    branches:
      - main
      - develop
    paths:
      - "src/**"
      - "public/**"
      - ".github/workflows/build.yaml"
  workflow_dispatch:  # Permet de déclencher manuellement le workflow

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build:
    env:
      RUSTC_WRAPPER: sccache
      SCCACHE_CACHE_SIZE: 2G
      SCCACHE_VERSION: 0.3.0
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: google/wireit@setup-github-actions-caching/v1
      - name: Cache rust stuff
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            ~/.cargo/bin
            src/rust/**/target/
          key: ${{ runner.os }}-cargo3-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo3-
      - name: sccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/sccache
          key: ${{ runner.os }}-sccache-${{ github.sha }}
          restore-keys: ${{ runner.os }}-sccache-
      - uses: dtolnay/rust-toolchain@nightly
        with:
          targets: wasm32-unknown-unknown
      - name: Install build dependencies
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          sudo ln -s $(which wasm-ld-13 || which wasm-ld-12 || which wasm-ld-11 || which wasm-ld-10) /usr/bin/wasm-ld

          # Install sccache first (required by RUSTC_WRAPPER)
          SCCACHE_FILE=sccache-v$SCCACHE_VERSION-x86_64-unknown-linux-musl
          curl -L https://github.com/mozilla/sccache/releases/download/v$SCCACHE_VERSION/$SCCACHE_FILE.tar.gz | tar -xz
          sudo mv -f $SCCACHE_FILE/sccache /usr/local/bin/sccache
          sudo chmod +x /usr/local/bin/sccache

          # Install aidoku-cli from git source (includes --name flag support)
          cargo install --git https://github.com/Aidoku/aidoku-rs aidoku-cli
      - name: Build Rust sources with aidoku package
        run: |
          # Initialize counters
          INDIVIDUAL_SUCCESS=0
          INDIVIDUAL_FAIL=0
          TEMPLATE_SUCCESS=0
          TEMPLATE_FAIL=0
          
          # Build individual sources with aidoku package
          echo "=== Building Individual Sources with aidoku package ==="
          for src in ./src/rust/fr.*; do
            if [ -d "$src" ] && [ -f "$src/Cargo.toml" ]; then
              SOURCE_NAME=$(basename "$src")
              echo "📦 Building individual source: $SOURCE_NAME"
              (
                cd "$src" || exit 1
                rm -f package.aix
                RUSTUP_TOOLCHAIN=nightly aidoku package
              ) && {
                echo "✅ Successfully built $SOURCE_NAME"
                INDIVIDUAL_SUCCESS=$((INDIVIDUAL_SUCCESS + 1))
              } || {
                echo "❌ Failed to build $SOURCE_NAME"
                INDIVIDUAL_FAIL=$((INDIVIDUAL_FAIL + 1))
              }
            fi
          done
          
          # Build template sources  
          echo "=== Building Template Sources with aidoku package ==="
          for template_dir in ./src/rust/madara ./src/rust/mangastream ./src/rust/mmrcms; do
            if [ -d "$template_dir/sources" ]; then
              TEMPLATE_NAME=$(basename "$template_dir")
              echo "📦 Processing template: $TEMPLATE_NAME"
              TEMPLATE_COUNT=0
              
              for source_dir in "$template_dir/sources"/*; do
                if [ -d "$source_dir" ]; then
                  SOURCE_NAME=$(basename "$source_dir")
                  echo "🔨 Building template source: $TEMPLATE_NAME/$SOURCE_NAME"
                  (
                    cd "$source_dir" || exit 1
                    rm -f package.aix
                    RUSTUP_TOOLCHAIN=nightly aidoku package
                    # Move package to template root for aidoku build
                    if [ -f "package.aix" ]; then
                      cp package.aix "../../$SOURCE_NAME.aix"
                    fi
                  ) && {
                    TEMPLATE_COUNT=$((TEMPLATE_COUNT + 1))
                  }
                fi
              done
              
              if [ $TEMPLATE_COUNT -gt 0 ]; then
                echo "✅ Built $TEMPLATE_COUNT sources for template $TEMPLATE_NAME"
                TEMPLATE_SUCCESS=$((TEMPLATE_SUCCESS + 1))
              else
                echo "❌ No sources built for template $TEMPLATE_NAME"
                TEMPLATE_FAIL=$((TEMPLATE_FAIL + 1))
              fi
            fi
          done
          
          echo "=== All packages created ==="
          echo "Individual packages:"
          ls -la ./src/rust/fr.*/package.aix 2>/dev/null || echo "  No individual packages found"
          echo "Template packages:"
          ls -la ./src/rust/madara/*.aix 2>/dev/null || echo "  No madara packages found"
          ls -la ./src/rust/mangastream/*.aix 2>/dev/null || echo "  No mangastream packages found"  
          ls -la ./src/rust/mmrcms/*.aix 2>/dev/null || echo "  No mmrcms packages found"
          
          # Export variables for next steps
          echo "INDIVIDUAL_SUCCESS=$INDIVIDUAL_SUCCESS" >> $GITHUB_ENV
          echo "INDIVIDUAL_FAIL=$INDIVIDUAL_FAIL" >> $GITHUB_ENV
          echo "TEMPLATE_SUCCESS=$TEMPLATE_SUCCESS" >> $GITHUB_ENV
          echo "TEMPLATE_FAIL=$TEMPLATE_FAIL" >> $GITHUB_ENV
      - name: Building source list
        run: |
          # Set source list name based on branch
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            SOURCE_NAME="JohanDevl's French Sources"
          else
            SOURCE_NAME="JohanDevl's French Sources (Development)"
          fi
          
          # Build source list from all packages
          echo "Building source list: $SOURCE_NAME"
          aidoku build ./src/rust/fr.*/package.aix ./src/rust/madara/*.aix ./src/rust/mangastream/*.aix ./src/rust/mmrcms/*.aix -o build_output --name "$SOURCE_NAME"

          # Extract icons from all packages manually
          echo "Extracting icons from packages..."
          mkdir -p build_output/icons
          
          # Extract from individual custom sources
          for package in ./src/rust/fr.*/package.aix; do
            if [ -f "$package" ]; then
              SOURCE_NAME=$(basename "$(dirname "$package")")
              echo "Extracting icon from $SOURCE_NAME"
              unzip -p "$package" Payload/Icon.png > "build_output/icons/${SOURCE_NAME}.png" 2>/dev/null || true
            fi
          done
          
          # Extract from template sources
          for package in ./src/rust/madara/*.aix ./src/rust/mangastream/*.aix ./src/rust/mmrcms/*.aix; do
            if [ -f "$package" ]; then
              SOURCE_NAME=$(basename "$package" .aix)
              echo "Extracting icon from $SOURCE_NAME"
              unzip -p "$package" Payload/Icon.png > "build_output/icons/${SOURCE_NAME}.png" 2>/dev/null || true
            fi
          done
          
          echo "Icons extracted. Contents of icons directory:"
          ls -la build_output/icons/

          # Copy output to public directory (preserving existing website files)
          cp -r build_output/* public/

          echo "Build completed. Generated files:"
          ls -la public/
      - name: Deploy to GitHub Pages (main -> sources)
        uses: JamesIves/github-pages-deploy-action@v4.7.2
        if: ${{ github.ref == 'refs/heads/main' }}
        with:
          branch: sources
          folder: public
          git-config-name: GitHub Actions
          git-config-email: github-actions[bot]@users.noreply.github.com
          commit-message: Update source list
          single-commit: true
      - name: Deploy to GitHub Pages (develop -> sources-develop)
        uses: JamesIves/github-pages-deploy-action@v4.7.2
        if: ${{ github.ref == 'refs/heads/develop' }}
        with:
          branch: sources-develop
          folder: public
          git-config-name: GitHub Actions
          git-config-email: github-actions[bot]@users.noreply.github.com
          commit-message: Update source list
          single-commit: true
      - name: Uploading packages as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: packages
          path: public/sources/*.aix
          if-no-files-found: ignore
      - name: Uploading gh-pages deployment as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gh-pages
          path: public
          if-no-files-found: ignore
      - name: Build Summary Report
        if: always()
        run: |
          # Calculate totals
          TOTAL_SUCCESS=$((INDIVIDUAL_SUCCESS + TEMPLATE_SUCCESS))
          TOTAL_FAIL=$((INDIVIDUAL_FAIL + TEMPLATE_FAIL))
          TOTAL_ATTEMPTED=$((TOTAL_SUCCESS + TOTAL_FAIL))
          INDIVIDUAL_TOTAL=$((INDIVIDUAL_SUCCESS + INDIVIDUAL_FAIL))
          TEMPLATE_TOTAL=$((TEMPLATE_SUCCESS + TEMPLATE_FAIL))

          # Count packages created
          PACKAGE_COUNT=$(find . -name "*.aix" -type f | wc -l)
          TOTAL_SIZE=$(find . -name "*.aix" -type f -exec du -ch {} + | grep total$ | cut -f1 || echo "0")

          # Determine deployment branch
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            DEPLOY_BRANCH="sources"
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            DEPLOY_BRANCH="sources-develop"
          else
            DEPLOY_BRANCH="none (not main or develop)"
          fi

          # Create GitHub Job Summary
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # 🏗️ Build Summary Report

          ## 📊 Build Statistics

          | Category | ✅ Success | ❌ Failed | 📦 Total |
          |----------|------------|-----------|----------|
          | **Individual Sources (fr.*)** | %INDIVIDUAL_SUCCESS% | %INDIVIDUAL_FAIL% | %INDIVIDUAL_TOTAL% |
          | **Template Sources** | %TEMPLATE_SUCCESS% | %TEMPLATE_FAIL% | %TEMPLATE_TOTAL% |
          | **🎯 Total** | **%TOTAL_SUCCESS%** | **%TOTAL_FAIL%** | **%TOTAL_ATTEMPTED%** |

          ## ✅ Successfully Built Sources

          ### Individual Sources
          EOF
          
          # Add individual sources
          if [ -n "$INDIVIDUAL_BUILT" ]; then
            for source in $INDIVIDUAL_BUILT; do
              echo "- ✅ **$source**" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- ℹ️ *No individual sources built*" >> $GITHUB_STEP_SUMMARY
          fi

          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ### Template Sources
          EOF

          # Add template sources
          if [ -n "$TEMPLATE_BUILT" ]; then
            for template in $TEMPLATE_BUILT; do
              echo "- ✅ **$template**" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- ℹ️ *No template sources built*" >> $GITHUB_STEP_SUMMARY
          fi

          # Add failed sources if any
          if [ $TOTAL_FAIL -gt 0 ]; then
            cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ## ❌ Failed Sources
          EOF
            if [ -n "$INDIVIDUAL_FAILED" ]; then
              echo "### Individual Sources" >> $GITHUB_STEP_SUMMARY
              for source in $INDIVIDUAL_FAILED; do
                echo "- ❌ **$source**" >> $GITHUB_STEP_SUMMARY
              done
            fi
            if [ -n "$TEMPLATE_FAILED" ]; then
              echo "### Template Sources" >> $GITHUB_STEP_SUMMARY
              for template in $TEMPLATE_FAILED; do
                echo "- ❌ **$template**" >> $GITHUB_STEP_SUMMARY
              done
            fi
          fi

          # Add package information
          cat >> $GITHUB_STEP_SUMMARY << EOF

          ## 📦 Package Information

          - **Total .aix packages**: $PACKAGE_COUNT
          - **Total size**: $TOTAL_SIZE
          - **Deployment branch**: \`$DEPLOY_BRANCH\`
          - **Artifacts uploaded**: packages, gh-pages

          ## 🔗 Useful Links

          - [📁 View Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [🌐 Deployed Sources](https://github.com/${{ github.repository }}/tree/$DEPLOY_BRANCH)
          - [📋 Source Repository](https://github.com/${{ github.repository }})

          ---
          *Build completed on $(date -u '+%Y-%m-%d %H:%M:%S UTC') • Commit: [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})*
          EOF

          # Replace placeholders
          sed -i "s/%INDIVIDUAL_SUCCESS%/$INDIVIDUAL_SUCCESS/g" $GITHUB_STEP_SUMMARY
          sed -i "s/%INDIVIDUAL_FAIL%/$INDIVIDUAL_FAIL/g" $GITHUB_STEP_SUMMARY
          sed -i "s/%INDIVIDUAL_TOTAL%/$INDIVIDUAL_TOTAL/g" $GITHUB_STEP_SUMMARY
          sed -i "s/%TEMPLATE_SUCCESS%/$TEMPLATE_SUCCESS/g" $GITHUB_STEP_SUMMARY
          sed -i "s/%TEMPLATE_FAIL%/$TEMPLATE_FAIL/g" $GITHUB_STEP_SUMMARY
          sed -i "s/%TEMPLATE_TOTAL%/$TEMPLATE_TOTAL/g" $GITHUB_STEP_SUMMARY
          sed -i "s/%TOTAL_SUCCESS%/$TOTAL_SUCCESS/g" $GITHUB_STEP_SUMMARY
          sed -i "s/%TOTAL_FAIL%/$TOTAL_FAIL/g" $GITHUB_STEP_SUMMARY  
          sed -i "s/%TOTAL_ATTEMPTED%/$TOTAL_ATTEMPTED/g" $GITHUB_STEP_SUMMARY

          # Console output summary
          echo "🎉 Build Summary:"
          echo "   ✅ $TOTAL_SUCCESS sources built successfully"
          echo "   ❌ $TOTAL_FAIL sources failed"
          echo "   📦 $PACKAGE_COUNT .aix packages created ($TOTAL_SIZE)"
          echo "   🚀 Deployed to branch: $DEPLOY_BRANCH"
